<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶å…‰ç”»å»Š | æˆ‘ä»¬çš„æ°¸ä¹…å›å¿†</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/compressorjs/1.2.0/compressor.min.js"></script>
    <style>
        :root {
            --primary: #FFB7C5;
            --secondary: #89C4F4;
            --accent: #98FB98;
            --text: #4A4A4A;
        }

        body {
            background: linear-gradient(135deg, 
                rgba(255,183,197,0.05) 0%, 
                rgba(137,196,244,0.05) 100%);
            font-family: 'Microsoft Yahei', sans-serif;
            min-height: 100vh;
        }

        /* ç”»å»Šå®¹å™¨ */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        /* æ™ºèƒ½ç½‘æ ¼å¸ƒå±€ */
        .photo-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2.5rem;
            padding: 3rem 0;
        }

        /* ç…§ç‰‡å¡ç‰‡ */
        .photo-card {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            position: relative;
            animation: cardEntrance 0.6s ease-out;
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .photo-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(255,183,197,0.2);
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 4rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }

        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            height: 8px;
            background: rgba(var(--primary),0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1.5rem;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>

<div class="gallery-container">
    <!-- ä¸Šä¼ æ§åˆ¶é¢æ¿ -->
    <div class="upload-panel">
        <h2 class="text-center mb-4">ğŸ“· æ°¸ä¹…ä¿å­˜æˆ‘ä»¬çš„å›å¿†</h2>
        <div class="upload-zone">
            <input type="file" id="fileInput" multiple accept="image/*" hidden>
            <label for="fileInput" class="upload-label">
                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                <div class="h4">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–å…¥ç…§ç‰‡</div>
                <small class="text-muted">æ”¯æŒJPG/PNG/WebPæ ¼å¼</small>
            </label>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- åŠ¨æ€ç…§ç‰‡å¢™ -->
    <div class="photo-wall" id="gallery"></div>
</div>

<script>
    // ============== é…ç½®åŒº ==============
    const GITHUB = {
        token: 'ghp_ä½ çš„GitHubToken',  // éœ€è¦æ›¿æ¢æˆçœŸå®Token
        repo: 'ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“å',  // ä¾‹å¦‚ï¼šcouple/blog
        path: 'images/'               // å­˜å‚¨è·¯å¾„
    };
    // ==================================

    // åˆå§‹åŒ–ç”»å»Š
    let photos = loadGallery();
    renderGallery();

    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            await processImage(file);
        }
    });

    // å›¾ç‰‡å¤„ç†æµç¨‹
    async function processImage(file) {
        try {
            // æ­¥éª¤1ï¼šå‹ç¼©å›¾ç‰‡
            const compressedFile = await compressImage(file);
            
            // æ­¥éª¤2ï¼šä¸Šä¼ åˆ°GitHub
            const imageUrl = await uploadToGitHub(compressedFile);
            
            // æ­¥éª¤3ï¼šæœ¬åœ°å­˜å‚¨è®°å½•
            savePhoto(imageUrl);
            
            // æ­¥éª¤4ï¼šæ›´æ–°ç”»å»Š
            renderGallery();
        } catch (error) {
            showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // å›¾ç‰‡å‹ç¼©
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            new Compressor(file, {
                quality: 0.8,
                convertSize: 1000000, // å¤§äº1MBè½¬WebP
                success(result) {
                    resolve(new File([result], file.name, {
                        type: 'image/webp',
                        lastModified: Date.now()
                    }));
                },
                error(err) {
                    reject(new Error('å›¾ç‰‡å¤„ç†å¤±è´¥'));
                }
            });
        });
    }

    // GitHubä¸Šä¼ 
    async function uploadToGitHub(file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        await new Promise(resolve => reader.onload = resolve);
        const content = reader.result.split(',')[1];

        const response = await fetch(`https://api.github.com/repos/${GITHUB.repo}/contents/${GITHUB.path}${file.name}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'æ·»åŠ æƒ…ä¾£ç…§ç‰‡',
                content: content,
                branch: 'main'
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        return data.content.download_url;
    }

    // æœ¬åœ°å­˜å‚¨ç®¡ç†
    function savePhoto(url) {
        photos = [...photos, url];
        localStorage.setItem('gallery', JSON.stringify(photos));
    }

    function loadGallery() {
        return JSON.parse(localStorage.getItem('gallery') || '[]');
    }

    // æ¸²æŸ“ç”»å»Š
    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = photos.map(url => `
            <div class="photo-card">
                <img src="${url}" 
                     class="gallery-image"
                     loading="lazy"
                     alt="æˆ‘ä»¬çš„å›å¿†">
                <div class="p-3 text-center">
                    <small class="text-muted">
                        <i class="fas fa-heartbeat me-2"></i>
                        ${new Date().toLocaleDateString()}
                    </small>
                </div>
            </div>
        `).join('');
    }

    // å·¥å…·å‡½æ•°
    function showMessage(text, type = 'success') {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.textContent = text;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
</script>

</body>
</html>
