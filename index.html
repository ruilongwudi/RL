<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>❤️ 我们的时光日记 ❤️</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 保持原有样式，新增以下修复 */
        .page {
            display: none;
            padding: 2rem 10%;
        }
        .page.active {
            display: block;
        }
        #gallery .upload-container {
            display: block; /* 确保上传区域仅在照片墙显示 */
        }
    </style>
</head>
<body>
    <!-- 导航栏修复 -->
    <nav class="nav-bar">
        <button class="nav-btn active" onclick="showPage('home')">首页</button>
        <button class="nav-btn" onclick="showPage('gallery')">照片墙</button>
        <button class="nav-btn" onclick="showPage('notes')">恋爱笔记</button>
    </nav>

    <!-- 首页修复 -->
    <section id="home" class="page active">
        <!-- 仅保留轮播图 -->
        <div class="photo-grid" id="carousel"></div>
    </section>

    <!-- 照片墙修复 -->
    <section id="gallery" class="page">
        <div class="upload-container">
            <!-- 上传组件 -->
        </div>
    </section>

    <!-- 恋爱笔记修复 -->
    <section id="notes" class="page">
        <!-- 笔记列表 -->
    </section>

    <script>
        // 修复页面切换功能
        function showPage(pageId) {
            // 移除所有按钮激活状态
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 激活目标页面和按钮
            document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
            document.getElementById(pageId).classList.add('active');
        }

        // 修复上传功能
        async function uploadPhoto() {
            const fileInput = document.getElementById('fileInput');
            if(fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            try {
                const storageRef = storage.ref(`photos/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);

                // 显示上传进度
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`上传进度: ${Math.round(progress)}%`);
                    },
                    (error) => {
                        alert(`上传失败: ${error.message}`);
                    },
                    async () => {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        await db.collection('photos').add({
                            url: downloadURL,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('上传成功！');
                    }
                );
            } catch (error) {
                alert(`上传错误: ${error.message}`);
            }
        }

        // 修复编辑器关闭功能
        function closeEditor() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            currentNoteId = null;
        }

        // 初始化事件监听（新增）
        document.addEventListener('DOMContentLoaded', () => {
            // 文件选择监听
            document.getElementById('fileInput').addEventListener('change', () => {
                document.querySelector('.upload-zone').classList.remove('dragover');
            });

            // 拖放功能修复
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                document.getElementById('fileInput').files = files;
            });
        });
    </script>
</body>
</html>
