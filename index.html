<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时光画廊 | 我们的永久回忆</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/compressorjs/1.2.0/compressor.min.js"></script>
    <style>
        :root {
            --primary: #FFB7C5;
            --secondary: #89C4F4;
            --accent: #98FB98;
            --text: #4A4A4A;
        }

        body {
            background: linear-gradient(135deg, 
                rgba(255,183,197,0.05) 0%, 
                rgba(137,196,244,0.05) 100%);
            font-family: 'Microsoft Yahei', sans-serif;
            min-height: 100vh;
        }

        /* 画廊容器 */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        /* 智能网格布局 */
        .photo-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2.5rem;
            padding: 3rem 0;
        }

        /* 照片卡片 */
        .photo-card {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            position: relative;
            animation: cardEntrance 0.6s ease-out;
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .photo-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(255,183,197,0.2);
        }

        /* 上传区域 */
        .upload-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 4rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }

        /* 进度条动画 */
        .progress-bar {
            height: 8px;
            background: rgba(var(--primary),0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1.5rem;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>

<div class="gallery-container">
    <!-- 上传控制面板 -->
    <div class="upload-panel">
        <h2 class="text-center mb-4">📷 永久保存我们的回忆</h2>
        <div class="upload-zone">
            <input type="file" id="fileInput" multiple accept="image/*" hidden>
            <label for="fileInput" class="upload-label">
                <i class="fas fa-cloud-upload-alt fa-2x mb-3"></i>
                <div class="h4">点击选择或拖入照片</div>
                <small class="text-muted">支持JPG/PNG/WebP格式</small>
            </label>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- 动态照片墙 -->
    <div class="photo-wall" id="gallery"></div>
</div>

<script>
    // ============== 配置区 ==============
    const GITHUB = {
        token: 'ghp_你的GitHubToken',  // 需要替换成真实Token
        repo: '你的用户名/你的仓库名',  // 例如：couple/blog
        path: 'images/'               // 存储路径
    };
    // ==================================

    // 初始化画廊
    let photos = loadGallery();
    renderGallery();

    // 文件选择处理
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            await processImage(file);
        }
    });

    // 图片处理流程
    async function processImage(file) {
        try {
            // 步骤1：压缩图片
            const compressedFile = await compressImage(file);
            
            // 步骤2：上传到GitHub
            const imageUrl = await uploadToGitHub(compressedFile);
            
            // 步骤3：本地存储记录
            savePhoto(imageUrl);
            
            // 步骤4：更新画廊
            renderGallery();
        } catch (error) {
            showMessage(`上传失败: ${error.message}`, 'error');
        }
    }

    // 图片压缩
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            new Compressor(file, {
                quality: 0.8,
                convertSize: 1000000, // 大于1MB转WebP
                success(result) {
                    resolve(new File([result], file.name, {
                        type: 'image/webp',
                        lastModified: Date.now()
                    }));
                },
                error(err) {
                    reject(new Error('图片处理失败'));
                }
            });
        });
    }

    // GitHub上传
    async function uploadToGitHub(file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        await new Promise(resolve => reader.onload = resolve);
        const content = reader.result.split(',')[1];

        const response = await fetch(`https://api.github.com/repos/${GITHUB.repo}/contents/${GITHUB.path}${file.name}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: '添加情侣照片',
                content: content,
                branch: 'main'
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        return data.content.download_url;
    }

    // 本地存储管理
    function savePhoto(url) {
        photos = [...photos, url];
        localStorage.setItem('gallery', JSON.stringify(photos));
    }

    function loadGallery() {
        return JSON.parse(localStorage.getItem('gallery') || '[]');
    }

    // 渲染画廊
    function renderGallery() {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = photos.map(url => `
            <div class="photo-card">
                <img src="${url}" 
                     class="gallery-image"
                     loading="lazy"
                     alt="我们的回忆">
                <div class="p-3 text-center">
                    <small class="text-muted">
                        <i class="fas fa-heartbeat me-2"></i>
                        ${new Date().toLocaleDateString()}
                    </small>
                </div>
            </div>
        `).join('');
    }

    // 工具函数
    function showMessage(text, type = 'success') {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.textContent = text;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
</script>

</body>
</html>
